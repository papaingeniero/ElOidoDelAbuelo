<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando - O√≠do del Abuelo</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1f1f1f;
            --text-color: #ffffff;
            --text-muted: #888888;
            --primary-color: #d32f2f;
            --primary-dark: #9a0007;
            --status-green: #03dac6;
            --status-yellow: #ffb300;
            --status-red: #d32f2f;
            --status-gray: #757575;
            --item-bg: #2c2c2c;
            --item-active: #3d3d3d;
            --max-amplitude: 32767;
        }

        html {
            overflow-x: hidden;
            overflow-y: auto;
            overscroll-behavior: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dashboard {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        h1 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
            letter-spacing: 1px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background-color: var(--status-gray);
            color: #fff;
        }

        .instrument-panel {
            margin-bottom: 20px;
            text-align: left;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meter-bg {
            width: 100%;
            height: 30px;
            background-color: #333;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            width: 0%;
            background-color: var(--status-green);
            transition: width 0.1s linear, background-color 0.2s ease;
        }

        .threshold-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: rgba(255, 255, 255, 0.4);
            left: calc((10000 / 32767) * 100%);
            z-index: 10;
            cursor: ew-resize;
            touch-action: none;
            /* Evita el scroll nativo al arrastrar */
        }

        .threshold-marker::after {
            content: "";
            position: absolute;
            top: -15px;
            bottom: -15px;
            left: -15px;
            right: -15px;
            /* Hitbox t√°ctil gigante para facilitar el agarre */
        }

        /* Reutilizamos el span para el texto de 'Umbral' de forma estable */
        .threshold-marker::before {
            content: "Umbral";
            position: absolute;
            top: -16px;
            left: -15px;
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: bold;
            pointer-events: none;
        }

        #thresholdLabel {
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--status-yellow);
            font-family: monospace;
            font-weight: bold;
            white-space: nowrap;
        }

        .meter-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            padding: 0 2px;
            font-size: 0.65rem;
            color: #888;
            font-family: monospace;
            letter-spacing: -0.5px;
        }

        .scale-mark {
            position: relative;
            text-align: center;
        }

        .scale-mark::before {
            content: "";
            position: absolute;
            top: -4px;
            left: 50%;
            width: 1px;
            height: 4px;
            background-color: #444;
        }

        .settings-btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .settings-btn:hover {
            opacity: 0.8;
            background-color: var(--primary-dark);
        }

        /* LIVE BUTTON PULSE ANIMATION (El Ojo Style) */
        .live-btn-active {
            background-color: var(--status-red) !important;
            color: white !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(211, 47, 47, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(211, 47, 47, 0);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: flex-start;
            /* Evitar que el centro exacto sature el Top-Bar */
            justify-content: center;
            padding-top: 60px;
            /* Separaci√≥n prudencial de la barra de navegaci√≥n del host */
        }

        .modal-content {
            background: #222222;
            padding: 25px 25px 60px 25px;
            border-radius: 12px;
            width: 85%;
            max-width: 400px;
            margin: 0 auto;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-height: 75vh;
            /* Evasi√≥n del error de Bottom-Bar / 100vh de Safari/Chrome m√≥vil */
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--status-green);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .form-group input[type="number"],
        .form-group input[type="range"] {
            width: 100%;
            box-sizing: border-box;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
        }

        .form-group input[type="checkbox"] {
            transform: scale(1.2);
        }

        .btn-row {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-save {
            background: #2e7d32;
            color: white;
            flex: 1;
            margin-right: 10px;
        }

        .btn-close {
            background: #c62828;
            color: white;
            flex: 1;
        }

        .history-panel {
            margin-top: 30px;
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: left;
        }

        .history-card {
            background-color: var(--item-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            border-left: 4px solid var(--status-gray);
            /* Cambiar√° din√°micamente */
            transition: transform 0.1s, background-color 0.2s;
        }

        .history-card:active {
            transform: scale(0.98);
            background-color: var(--item-active);
        }

        /* Tarjeta VISITADA ‚Äî azul medianoche suave */
        .history-card.visited {
            background-color: #1a2a3a;
            border-left-color: #4a90d9;
        }

        /* Tarjeta DESTACADA ‚Äî √°mbar/dorado por long-press */
        .history-card.highlighted {
            background-color: #3a2f1a;
            border-left-color: #f5a623;
            box-shadow: 0 0 12px rgba(245, 166, 35, 0.25);
        }

        .history-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: bold;
            font-size: 0.95rem;
            color: #fff;
        }

        .history-size {
            font-size: 0.8rem;
            color: #aaa;
        }

        audio {
            width: 100%;
            height: 35px;
            outline: none;
            border-radius: 20px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .3s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--status-green);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.05);
            padding: 12px 15px;
            border-radius: 8px;
        }

        .setting-label {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* CSS para inmovilizar el Scroll principal */
        body.modal-open {
            overflow: hidden;
        }
    </style>
</head>

<body>

    <div class="dashboard">
        <h1>El O√≠do del Abuelo <span id="appVersion" style="font-size: 0.8rem; color: var(--status-gray);"></span></h1>
        <div id="statusBadge" class="status-badge">Vigilando</div>
        <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Ajustes</button>

        <!-- HARDWARE TELEMETRY TOOLBAR -->
        <div id="telemetryToolbar"
            style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 5px auto 15px auto; background: rgba(255, 255, 255, 0.05); padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(4px); font-size: 0.85rem; font-weight: bold; width: fit-content; transition: all 0.3s;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <span id="batteryIcon" style="transition: color 0.3s; font-size: 1.1rem;">üîã</span>
                <span id="batteryText" style="transition: color 0.3s; color: #fff;">--%</span>
            </div>
            <div style="width: 1px; height: 15px; background: rgba(255,255,255,0.2);"></div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <span id="tempIcon" style="transition: color 0.3s; font-size: 1.1rem;">üå°Ô∏è</span>
                <span id="tempText" style="transition: color 0.3s; color: #fff;">--¬∞C</span>
            </div>
        </div>

        <br>
        <div id="system-state-badge"
            style="text-align: center; font-size: 1.05rem; font-weight: bold; margin-bottom: 15px; padding: 12px; border-radius: 8px; background: #1a1a1a; border: 1px solid #333; letter-spacing: 0.5px;">
            ‚è≥ CONECTANDO CON EL CENTINELA...
        </div>
        <button id="btnRecMaster" class="pill-btn"
            style="display: block; width: 100%; margin: 10px 0 25px 0; text-align: center; font-size: 1.3rem; padding: 18px; background-color: var(--status-red); border: none; color: white; border-radius: 12px; font-weight: bold; cursor: pointer; transition: background 0.2s;"
            onclick="toggleContinuousRec()">
            ‚è∫Ô∏è GRABAR AHORA
        </button>

        <div class="instrument-panel">
            <button id="btnLive" class="settings-btn"
                style="background-color: var(--status-gray); display: block; width: 100%; margin-top: 10px; margin-bottom: 30px; text-align: center; font-size: 1.1rem; padding: 15px;"
                onclick="toggleLiveAudio()">üìª Escuchar en Vivo (OFF)</button>
            <div class="label-row">
                <span>Amplitud de Micr√≥fono</span>
                <span id="amplitudeValue">0</span>
            </div>
            <div class="meter-bg" style="overflow: visible; margin-bottom: 25px;">
                <div id="vumeter" class="meter-fill" style="border-radius: 6px;"></div>
                <div class="threshold-marker">
                    <span id="thresholdLabel">10000</span>
                </div>
                <div class="meter-scale" style="position: absolute; bottom: -22px; width: 100%; padding: 0;">
                    <span class="scale-mark">0</span>
                    <span class="scale-mark">8k</span>
                    <span class="scale-mark">16k</span>
                    <span class="scale-mark">24k</span>
                    <span class="scale-mark">32k</span>
                </div>
            </div>
        </div>
    </div>

    <div class="history-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin: 0; color: var(--primary-color);">Historial de Alertas</h2>
            <button class="settings-btn" style="margin: 0;" onclick="loadHistory()">üîÑ Actualizar</button>
        </div>
        <div id="historyContainer">
            <p style="text-align: center; color: #888; font-size: 0.9rem;">Cargando historial...</p>
        </div>
    </div>

    <!-- Modal de Ajustes -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Ajustes del Centinela</h2>
                <button onclick="closeSettings()"
                    style="background: none; border: none; color: #888; font-size: 2rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <strong style="color: #fff; font-size: 1.05rem;">Hardware Micr√≥fono</strong>
                    <span style="font-size: 0.8rem; color: #aaa;">Maestro Kill-Switch. Si se apaga, el m√≥vil queda
                        totalmente sordo.</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="inpMicEnabled" onchange="toggleShieldVisibility()">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row" id="autoDetectionRow">
                <div class="setting-label">
                    <strong style="color: #fff; font-size: 1.05rem;">Detecci√≥n Autom√°tica</strong>
                    <span style="font-size: 0.8rem; color: #aaa;">Si el Micro est√° ON, permite escuchar alertas
                        autom√°ticas por ruidos.</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="inpAutoDetectionEnabled">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="setting-row" id="shieldRow">
                <div class="setting-label">
                    <strong style="color: #fff; font-size: 1.05rem;">Filtro Anti-Falsas Alarmas</strong>
                    <span style="font-size: 0.8rem; color: #aaa;">Obliga al micr√≥fono a escuchar varios tirones seguidos
                        para grabar.</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="inpShieldEnabled">
                    <span class="slider"></span>
                </label>
            </div>

            <div class="form-group">
                <label>Volumen m√≠nimo de disparo: <strong id="valSpike"
                        style="color:var(--status-green);">10000</strong></label>
                <input type="range" id="inpSpike" min="0" max="32767" value="10000"
                    oninput="document.getElementById('valSpike').innerText=this.value">
            </div>
            <div class="form-group">
                <label>Picos Consecutivos para saltar (REQUIRED_SPIKES)</label>
                <input type="number" id="inpRequired" min="1" max="10">
            </div>
            <div class="form-group">
                <label>SHIELD_WINDOW_MS (Ventana de Tolerancia MS)</label>
                <input type="number" id="inpWindow" min="100" max="5000">
            </div>
            <div class="form-group">
                <label>RECORD_DURATION_MS (Duraci√≥n Grabaci√≥n MS)</label>
                <input type="number" id="inpDuration" min="1000" max="60000">
            </div>
            <div class="form-group" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 20px;">
                <label style="color: var(--status-red); font-weight: bold;">‚ö†Ô∏è ZONA DE PELIGRO</label>
                <button class="btn" style="background: var(--status-red); color: white; width: 100%; margin-top: 10px;"
                    onclick="deleteRecordings()">üóëÔ∏è Purgar Todo el Historial</button>
            </div>
            <div class="btn-row" style="padding-bottom: 100px;">
                <button class="btn btn-close" onclick="closeSettings()">Cancelar</button>
                <button class="btn btn-save" onclick="saveSettings()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal del Waveform Player -->
    <div id="waveformModal" class="modal">
        <div class="modal-content" style="max-height: 85vh; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="waveTitle"
                    style="margin: 0; font-size: 1.1rem; color: var(--primary-color); word-break: break-all;">
                    Analizando...</h2>
                <button onclick="closeWaveform()"
                    style="background: none; border: none; color: #888; font-size: 2rem; cursor: pointer; padding: 0; line-height: 1;">&times;</button>
            </div>

            <div style="background: #111; border-radius: 8px; padding: 10px; margin-bottom: 15px; position: relative;">
                <canvas id="waveCanvas" width="400" height="120"
                    style="width: 100%; height: 120px; cursor: pointer; display: block;"></canvas>
                <!-- Mensaje de Carga Superpuesto -->
                <div id="waveLoading"
                    style="position: absolute; top:0; left:0; right:0; bottom:0; display:flex; justify-content:center; align-items:center; background: rgba(0,0,0,0.7); border-radius: 8px; font-weight: bold; color: var(--status-green);">
                    üîÑ Procesando Audio...
                </div>
            </div>

            <div style="text-align: center; margin-bottom: 15px; font-family: monospace; font-size: 1.2rem; color: #ccc;"
                id="waveTimeDisplay">
                00:00 / 00:00
            </div>

            <div style="display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; align-items: center;">
                <button class="settings-btn" style="margin:0; padding: 10px 15px; font-size: 1.2rem;"
                    onclick="seekWaveform(-5)">‚èÆ -5s</button>
                <button id="wavePlayBtn" class="pill-btn"
                    style="background: var(--status-green); border: none; color: black; padding: 10px 25px; border-radius: 20px; font-weight: bold; font-size: 1.2rem; cursor: pointer;"
                    onclick="toggleWaveformPlay()">‚ñ∂Ô∏è PLAY</button>
                <button class="settings-btn" style="margin:0; padding: 10px 15px; font-size: 1.2rem;"
                    onclick="seekWaveform(5)">+5s ‚è≠</button>
            </div>
        </div>
    </div>

    <script>
        const MAX_AMPLITUDE = 32767;
        let latestConfig = {};

        // Reproducci√≥n exclusiva: Detener otros audios al reproducir uno nuevo
        document.addEventListener('play', function (e) {
            if (e.target.tagName === 'AUDIO') {
                // Pausar cualquier otro audio del historial
                document.querySelectorAll('audio').forEach(function (audioElement) {
                    if (audioElement !== e.target) {
                        audioElement.pause();
                    }
                });

                // Apagar el stream en vivo si estaba sonando
                if (liveAudioElement != null) {
                    toggleLiveAudio();
                }
            }
        }, true); // Usar fase de captura porque los eventos media no burbujean

        // Elementos Dashboard (se obtienen en cada ciclo por seguridad V35)
        function updateDashboard() {
            const vumeter = document.getElementById('vumeter');
            const statusBadge = document.getElementById('statusBadge');
            const amplitudeValue = document.getElementById('amplitudeValue');
            const btnRecMaster = document.getElementById('btnRecMaster');

            // Si no hay vumeter, probablemente el dashboard no est√° cargado, pero no abortamos todo el fetch
            // para permitir que la l√≥gica de configuraci√≥n (latestConfig) se actualice.
            const hasDashboard = vumeter && statusBadge && amplitudeValue && btnRecMaster;

            fetch('/api/status')
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    const amp = data.currentAmplitude || 0;
                    const isRecording = data.isRecording;

                    const micEnabled = data.micEnabled !== undefined ? data.micEnabled : true;
                    const autoDetectionEnabled = data.autoDetectionEnabled !== undefined ? data.autoDetectionEnabled : true;
                    const shieldEnabled = data.shieldEnabled !== undefined ? data.shieldEnabled : true;
                    const forceRecord = data.forceRecord || false;

                    latestConfig = data; // Almacenamos para rellenar el modal

                    if (data.version) {
                        document.getElementById('appVersion').textContent = data.version;
                        document.title = "El O√≠do del Abuelo - " + data.version;
                    }

                    // Hardware Telemetry
                    if (data.batteryPct !== undefined && data.tempCelsius !== undefined) {
                        const batText = document.getElementById('batteryText');
                        const batIcon = document.getElementById('batteryIcon');
                        const tempText = document.getElementById('tempText');
                        const tempIcon = document.getElementById('tempIcon');

                        if (batText && batIcon && tempText && tempIcon) {
                            batText.textContent = data.batteryPct + "%" + (data.isCharging ? " (AC)" : "");
                            if (data.isCharging) {
                                batText.style.color = "var(--status-green)";
                                batIcon.textContent = "‚ö°";
                            } else if (data.batteryPct <= 20) {
                                batText.style.color = "var(--status-red)";
                                batIcon.textContent = "ü™´";
                            } else {
                                batText.style.color = "#fff";
                                batIcon.textContent = "üîã";
                            }

                            tempText.textContent = data.tempCelsius.toFixed(1) + "¬∞C";
                            if (data.tempCelsius > 40) {
                                tempText.style.color = "var(--status-red)";
                                tempIcon.style.color = "var(--status-red)";
                            } else if (data.tempCelsius > 35) {
                                tempText.style.color = "orange";
                                tempIcon.style.color = "orange";
                            } else {
                                tempText.style.color = "#fff";
                                tempIcon.style.color = "inherit";
                            }
                        }
                    }

                    // Ajustar UI del threshold-marker (Saltar si se est√° arrastrando - V59)
                    if (typeof isDraggingThreshold === 'undefined' || !isDraggingThreshold) {
                        const marker = document.querySelector('.threshold-marker');
                        const thresholdLabel = document.getElementById('thresholdLabel');
                        if (marker) {
                            let currentSpikeThreshold = (data.SPIKE_THRESHOLD !== undefined) ? data.SPIKE_THRESHOLD : 10000;
                            marker.style.left = `calc((${currentSpikeThreshold} / 32767) * 100%)`;
                            if (thresholdLabel) thresholdLabel.textContent = currentSpikeThreshold;
                        }
                    }

                    // Actualizar texto num√©rico
                    if (amplitudeValue) amplitudeValue.textContent = Math.round(amp);

                    // Calcular porcentaje para ancho CSS
                    let percentage = (amp / MAX_AMPLITUDE) * 100;
                    if (percentage > 100) percentage = 100;
                    if (vumeter) vumeter.style.width = percentage + '%';

                    // L√≥gica de colores y estados - V38 Dicotom√≠a: El badge narra, el bot√≥n act√∫a
                    const btn = btnRecMaster;
                    const stateBadge = document.getElementById('system-state-badge');
                    const btnLive = document.getElementById('btnLive');

                    if (micEnabled === false) {
                        if (stateBadge) {
                            stateBadge.innerHTML = "üî¥ ESTADO: MICR√ìFONO APAGADO (KILL SWITCH)";
                            stateBadge.style.color = "#ff5252";
                            stateBadge.style.borderColor = "#4a1c1c";
                        }
                        if (vumeter) vumeter.style.backgroundColor = "var(--status-gray)";
                        if (btn) {
                            btn.innerHTML = "‚è∫Ô∏è GRABAR AHORA";
                            btn.className = "pill-btn"; // Clase base
                            btn.style.backgroundColor = "var(--status-gray)";
                            btn.disabled = true;
                        }
                        if (btnLive) {
                            btnLive.disabled = true;
                            btnLive.style.opacity = "0.5";
                            btnLive.innerHTML = "üìª Escuchar en Vivo (Hardware OFF)";
                            stopLiveStream();
                        }
                    } else if (forceRecord) {
                        if (stateBadge) {
                            stateBadge.innerHTML = "üî¥ ESTADO: GRABACI√ìN MANUAL FORZADA";
                            stateBadge.style.color = "#ff5252";
                            stateBadge.style.borderColor = "#4a1c1c";
                        }
                        if (vumeter) vumeter.style.backgroundColor = "var(--status-red)";

                        let timeStr = "00:00:00";
                        if (data.recordingStartTimestamp) {
                            const diff = Math.floor((Date.now() - data.recordingStartTimestamp) / 1000);
                            const h = String(Math.floor(diff / 3600)).padStart(2, '0');
                            const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
                            const s = String(diff % 60).padStart(2, '0');
                            timeStr = `${h}:${m}:${s}`;
                        }
                        if (btn) {
                            btn.innerHTML = `‚èπÔ∏è DETENER GRABACI√ìN [${timeStr}]`;
                            btn.className = "pill-btn active";
                            btn.style.backgroundColor = "#555";
                            btn.disabled = false;
                        }
                        if (btnLive) {
                            btnLive.disabled = false;
                            btnLive.style.opacity = "1";
                            if (!liveAudioElement) btnLive.innerHTML = "üìª Escuchar en Vivo (OFF)";
                        }
                    } else if (isRecording) {
                        if (stateBadge) {
                            stateBadge.innerHTML = "üî¥ ESTADO: GRABANDO ALARMA POR RUIDO";
                            stateBadge.style.color = "#ff5252";
                            stateBadge.style.borderColor = "#4a1c1c";
                        }
                        if (vumeter) vumeter.style.backgroundColor = "var(--status-red)";

                        let timeStr = "00:00:00";
                        if (data.recordingStartTimestamp) {
                            const diff = Math.floor((Date.now() - data.recordingStartTimestamp) / 1000);
                            const h = String(Math.floor(diff / 3600)).padStart(2, '0');
                            const m = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
                            const s = String(diff % 60).padStart(2, '0');
                            timeStr = `${h}:${m}:${s}`;
                        }
                        if (btn) {
                            btn.innerHTML = `‚èπÔ∏è ABORTAR GRABACI√ìN AUTOM√ÅTICA [${timeStr}]`;
                            btn.className = "pill-btn active";
                            btn.style.backgroundColor = "var(--status-red)";
                            btn.disabled = false;
                        }
                        if (btnLive) {
                            btnLive.disabled = false;
                            btnLive.style.opacity = "1";
                            if (!liveAudioElement) btnLive.innerHTML = "üìª Escuchar en Vivo (OFF)";
                        }
                    } else if (autoDetectionEnabled === false) {
                        if (stateBadge) {
                            stateBadge.innerHTML = "üü° ESTADO: S√ìLO ESCUCHA (DETECCI√ìN OFF)";
                            stateBadge.style.color = "#ffd600";
                            stateBadge.style.borderColor = "#4a401c";
                        }
                        if (vumeter) vumeter.style.backgroundColor = "var(--status-green)";
                        if (btn) {
                            btn.innerHTML = "‚è∫Ô∏è GRABAR AHORA";
                            btn.className = "pill-btn";
                            btn.style.backgroundColor = "var(--status-red)";
                            btn.disabled = false;
                        }
                        if (btnLive) {
                            btnLive.disabled = false;
                            btnLive.style.opacity = "1";
                            if (!liveAudioElement) btnLive.innerHTML = "üìª Escuchar en Vivo (OFF)";
                        }
                    } else {
                        if (stateBadge) {
                            stateBadge.innerHTML = "üü¢ ESTADO: VIGILANDO (DETECTANDO SONIDO)";
                            stateBadge.style.color = "#03dac6";
                            stateBadge.style.borderColor = "#014a43";
                        }
                        if (btn) {
                            btn.innerHTML = "‚è∫Ô∏è GRABAR AHORA";
                            btn.className = "pill-btn";
                            btn.style.backgroundColor = "var(--primary-dark)";
                            btn.disabled = false;
                        }
                        if (btnLive) {
                            btnLive.disabled = false;
                            btnLive.style.opacity = "1";
                            if (!liveAudioElement) btnLive.innerHTML = "üìª Escuchar en Vivo (OFF)";
                        }

                        // V√∫metro din√°mico en escucha
                        let currentSpikeThreshold = (data.SPIKE_THRESHOLD !== undefined) ? data.SPIKE_THRESHOLD : 10000;
                        if (amp > currentSpikeThreshold) {
                            if (vumeter) vumeter.style.backgroundColor = shieldEnabled ? "var(--status-yellow)" : "var(--status-red)";
                        } else {
                            if (vumeter) vumeter.style.backgroundColor = "var(--status-green)";
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    const statusBadge = document.getElementById('statusBadge');
                    const vumeter = document.getElementById('vumeter');
                    if (statusBadge) {
                        statusBadge.textContent = "Sin Conexi√≥n";
                        statusBadge.style.backgroundColor = "var(--status-gray)";
                    }
                    if (vumeter) vumeter.style.width = '0%';
                });
        }

        function openSettings() {
            document.getElementById('inpMicEnabled').checked = (latestConfig.micEnabled !== undefined) ? latestConfig.micEnabled : true;
            document.getElementById('inpAutoDetectionEnabled').checked = (latestConfig.autoDetectionEnabled !== undefined) ? latestConfig.autoDetectionEnabled : true;
            document.getElementById('inpShieldEnabled').checked = (latestConfig.shieldEnabled !== undefined) ? latestConfig.shieldEnabled : true;
            toggleShieldVisibility();

            document.getElementById('inpSpike').value = latestConfig.SPIKE_THRESHOLD ?? 10000;
            document.getElementById('valSpike').innerText = latestConfig.SPIKE_THRESHOLD ?? 10000;
            document.getElementById('inpRequired').value = latestConfig.REQUIRED_SPIKES ?? 3;
            document.getElementById('inpWindow').value = latestConfig.SHIELD_WINDOW_MS ?? 500;
            document.getElementById('inpDuration').value = latestConfig.RECORD_DURATION_MS ?? 15000;

            document.body.classList.add('modal-open');
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.body.classList.remove('modal-open');
            document.getElementById('settingsModal').style.display = 'none';
        }

        function toggleShieldVisibility() {
            const mic = document.getElementById('inpMicEnabled').checked;
            document.getElementById('shieldRow').style.opacity = mic ? '1' : '0.3';
            document.getElementById('shieldRow').style.pointerEvents = mic ? 'auto' : 'none';
            document.getElementById('autoDetectionRow').style.opacity = mic ? '1' : '0.3';
            document.getElementById('autoDetectionRow').style.pointerEvents = mic ? 'auto' : 'none';
        }

        function toggleContinuousRec() {
            if (latestConfig && latestConfig.micEnabled === false) {
                alert("‚ö†Ô∏è Active la [Vigilancia Activa] en Ajustes primero.");
                return;
            }

            const isForced = latestConfig && latestConfig.forceRecord;
            const isRecordingAuto = latestConfig && latestConfig.isRecording && !isForced;

            // Si est√° grabando por detecci√≥n autom√°tica, el bot√≥n act√∫a como ABORTAR
            if (isRecordingAuto) {
                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ abortRecording: true })
                }).then(res => res.json()).then(data => {
                    if (data.status !== 'ok') alert("Error: " + data.message);
                    updateDashboard();
                }).catch(err => alert("Error de red al abortar grabaci√≥n"));
                return;
            }

            // Comportamiento normal (Toggle Grabaci√≥n Manual)
            const newForceState = !isForced;
            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ forceRecord: newForceState })
            }).then(res => res.json()).then(data => {
                if (data.status !== 'ok') alert("Error: " + data.message);
                updateDashboard();
            }).catch(err => alert("Error de red al activar/desactivar grabaci√≥n"));
        }

        function saveSettings() {
            const payload = {
                micEnabled: document.getElementById('inpMicEnabled').checked,
                autoDetectionEnabled: document.getElementById('inpAutoDetectionEnabled').checked,
                shieldEnabled: document.getElementById('inpShieldEnabled').checked,
                SPIKE_THRESHOLD: parseInt(document.getElementById('inpSpike').value),
                REQUIRED_SPIKES: parseInt(document.getElementById('inpRequired').value),
                SHIELD_WINDOW_MS: parseInt(document.getElementById('inpWindow').value),
                RECORD_DURATION_MS: parseInt(document.getElementById('inpDuration').value)
            };

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        closeSettings();
                        updateDashboard();
                    } else {
                        alert("Error guardando: " + data.message);
                    }
                })
                .catch(err => alert("Error de red al guardar"));
        }

        function deleteRecordings() {
            if (!confirm("‚ö†Ô∏è ¬øPulsar el Bot√≥n del P√°nico? Se borrar√° TODO el historial permanentemente.")) return;

            fetch('/api/recordings', { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        loadHistory();
                    } else {
                        alert("Error borrando: " + data.message);
                    }
                });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- MINI WAVEFORM: Dibujante de ondas en miniatura (Chivato JSON V49, Norm V52) ---
        function drawMiniWaveform(canvasId, peaks) {
            const canvas = document.getElementById(canvasId);
            if (!canvas || !peaks || peaks.length === 0) return;
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const step = width / peaks.length;

            // Normalizaci√≥n Pura: El pico m√°ximo es nuestro techo exacto (m√≠nimo 100 para evitar div/0)
            const localMax = Math.max(...peaks, 100);

            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = '#03dac6';

            for (let i = 0; i < peaks.length; i++) {
                const normalized = peaks[i] / localMax;
                const barHeight = Math.max(1, normalized * height);
                const x = i * step;
                const y = (height - barHeight) / 2;
                ctx.fillRect(x, y, Math.max(1, step - 0.5), barHeight);
            }

            // Etiqueta de pico m√°ximo (V53)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            ctx.font = '11px monospace';
            ctx.textAlign = 'left';
            ctx.fillText('Pico: ' + localMax, 4, 12);
        }

        let globalHistoryFiles = [];

        function loadHistory() {
            fetch('/api/recordings')
                .then(r => r.json())
                .then(files => {
                    const list = document.getElementById('historyContainer');
                    list.innerHTML = '';
                    globalHistoryFiles = files;
                    if (files.length === 0) {
                        list.innerHTML = '<div style="text-align:center; color:#888;">No hay grabaciones todav√≠a.</div>';
                        return;
                    }

                    files.forEach(f => {
                        const card = document.createElement('div');
                        card.className = 'history-card';
                        card.dataset.filename = f.name;

                        // Estado VISITADA (sessionStorage)
                        if (sessionStorage.getItem('visited_' + f.name)) {
                            card.classList.add('visited');
                        } else {
                            // Color rojo carmes√≠ base solo si no est√° visitada
                            card.style.borderLeftColor = 'var(--status-red)';
                        }

                        const dateObj = new Date(f.timestamp);
                        const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();

                        // Formatear tama√±o a KB o MB
                        const sizeKB = f.size / 1024;
                        const sizeStr = sizeKB > 1024 ? (sizeKB / 1024).toFixed(2) + ' MB' : sizeKB.toFixed(1) + ' KB';

                        // Formatear duraci√≥n (MM:SS)
                        const durSec = Math.floor((f.durationMs || 0) / 1000);
                        const durMin = Math.floor(durSec / 60);
                        const durRemSec = durSec % 60;
                        const durStr = durSec > 0 ? String(durMin).padStart(2, '0') + ':' + String(durRemSec).padStart(2, '0') : '--:--';

                        // Generar un ID seguro para el canvas (sin puntos ni caracteres especiales)
                        const canvasId = 'miniwave_' + f.name.replace(/[^a-zA-Z0-9]/g, '_');

                        card.innerHTML = `
                            <div class="history-card-header">
                                <span class="history-date">üö® ${dateStr}</span>
                                <span class="history-size">‚è±Ô∏è ${durStr} ¬∑ üìÅ ${sizeStr}</span>
                            </div>
                            <canvas id="${canvasId}" width="400" height="40" style="width:100%; height:40px; display:${f.peaks ? 'block' : 'none'}; margin-top:8px; border-radius:6px; background:#1a1a1a;"></canvas>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button class="settings-btn" style="flex: 1; margin: 0; background: #333; padding: 12px; font-size: 1.05rem;" onclick="openWaveform('${f.name}')">üëÅÔ∏è Analizar Pista</button>
                                <button class="settings-btn export-btn" style="flex: 0 0 auto; margin: 0; background: #283593; padding: 12px; font-size: 1.05rem;" onclick="exportAudio('${f.name}', this)">üì§ Exportar</button>
                            </div>
                        `;

                        // Long-press HIGHLIGHT (toggle √°mbar/dorado)
                        let longPressTimer = null;
                        let longPressTriggered = false;

                        function startLongPress(e) {
                            longPressTriggered = false;
                            longPressTimer = setTimeout(function () {
                                longPressTriggered = true;
                                card.classList.toggle('highlighted');
                            }, 600);
                        }

                        function cancelLongPress(e) {
                            if (longPressTimer) {
                                clearTimeout(longPressTimer);
                                longPressTimer = null;
                            }
                        }

                        // Touch events (m√≥vil)
                        card.addEventListener('touchstart', startLongPress, { passive: true });
                        card.addEventListener('touchend', cancelLongPress);
                        card.addEventListener('touchmove', cancelLongPress);
                        // Mouse events (desktop)
                        card.addEventListener('mousedown', startLongPress);
                        card.addEventListener('mouseup', cancelLongPress);
                        card.addEventListener('mouseleave', cancelLongPress);

                        list.appendChild(card);

                        // Dibujar mini-waveform si hay picos disponibles (V49)
                        if (f.peaks && f.peaks.length > 0) {
                            drawMiniWaveform(canvasId, f.peaks);
                        }
                    });
                })
                .catch(err => {
                    console.error("Error cargando historial:", err);
                    const list = document.getElementById('historyContainer');
                    list.innerHTML = '<p style="text-align: center; color: var(--status-red); font-size: 0.9rem;">Error de conexi√≥n.</p>';
                });
        }

        let liveAudioElement = null;

        function playLiveStream() {
            if (liveAudioElement) return;

            // Native HTML5 Audio Element for ADTS AAC Stream
            liveAudioElement = new Audio('/api/stream?' + new Date().getTime());
            liveAudioElement.crossOrigin = "anonymous";
            liveAudioElement.autoplay = true;
            // Previene el almacenamiento en cache agresivo del AAC inf√≠nito
            liveAudioElement.preload = "none";

            liveAudioElement.addEventListener('error', function (e) {
                console.error("Error en streaming AAC nativo", e);
                stopLiveStream();
            });

            liveAudioElement.play().catch(e => {
                console.error("Autoplay bloqueado:", e);
                alert("El navegador bloque√≥ la reproducci√≥n autom√°tica. Interact√∫e con la p√°gina.");
                stopLiveStream();
            });
        }

        function stopLiveStream() {
            if (liveAudioElement) {
                liveAudioElement.pause();
                liveAudioElement.src = "";
                liveAudioElement.load();
                liveAudioElement = null;
            }
            const btn = document.getElementById('btnLive');
            btn.textContent = "üìª Escuchar en Vivo (OFF)";
            btn.classList.remove('live-btn-active');
        }

        function toggleLiveAudio() {
            const btn = document.getElementById('btnLive');
            if (!liveAudioElement) {
                // Pausar cualquier audio del historial
                document.querySelectorAll('audio').forEach(a => {
                    if (a !== liveAudioElement) a.pause();
                });

                playLiveStream();
                btn.textContent = "üìª Escuchar en Vivo (ON)";
                btn.classList.add('live-btn-active');
            } else {
                stopLiveStream();
            }
        }

        // --- REPRODUCTOR DE ONDA FORENSE (LIGHTWEIGHT STREAMING ENGINE) ---
        let forensicAudio = null;
        let forensicAudioUrl = ''; // URL para crear el Audio solo en PLAY
        let forensicPeaks = [];
        let forensicDuration = 0;
        let isWavePlaying = false;
        let waveFileName = "";

        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const waveLoading = document.getElementById('waveLoading');
        const waveTitle = document.getElementById('waveTitle');
        const waveTimeDisplay = document.getElementById('waveTimeDisplay');
        const wavePlayBtn = document.getElementById('wavePlayBtn');

        function openWaveform(fileName) {
            sessionStorage.setItem('visited_' + fileName, '1');
            const targetCard = document.querySelector('.history-card[data-filename="' + fileName + '"]');
            if (targetCard) {
                targetCard.classList.add('visited');
                targetCard.style.borderLeftColor = '';
            }
            document.querySelectorAll('audio').forEach(a => a.pause());
            if (typeof liveAudioElement !== 'undefined' && liveAudioElement) stopLiveStream();

            waveFileName = fileName;
            waveTitle.innerText = "Analizando: " + decodeURIComponent(fileName);
            waveLoading.style.display = 'flex';
            document.getElementById('waveformModal').style.display = 'flex';
            document.body.classList.add('modal-open');

            // Recuperar datos del JSON ya cargados en memoria
            const fileObj = globalHistoryFiles.find(f => f.name === fileName);
            if (fileObj && fileObj.peaks && fileObj.peaks.length > 0) {
                forensicPeaks = fileObj.peaks;
                forensicDuration = (fileObj.durationMs || 0) / 1000;
            } else {
                forensicPeaks = [0]; // Fallback si es un archivo muy antiguo sin JSON
                forensicDuration = 1;
            }

            if (forensicAudio) {
                forensicAudio.pause();
                forensicAudio.src = '';
                forensicAudio = null;
            }

            // Guardar URL para crear el Audio SOLO al pulsar PLAY (Safari iOS)
            forensicAudioUrl = '/api/audio?file=' + encodeURIComponent(fileName);

            // Si ya tenemos picos del JSON: dibujar la onda INMEDIATAMENTE
            if (forensicPeaks.length > 1 && forensicDuration > 0) {
                waveLoading.style.display = 'none';
                drawForensicWaveform();
                updateWaveTimeDisplay();
            } else {
                // Archivo sin JSON (grabaci√≥n antigua o larga sin Chivato)
                waveLoading.style.display = 'none';
                drawForensicWaveform();
                updateWaveTimeDisplay();
            }
        }

        function closeWaveform() {
            if (forensicAudio) {
                forensicAudio.pause();
                forensicAudio.src = '';
                forensicAudio = null;
            }
            forensicAudioUrl = '';
            isWavePlaying = false;
            wavePlayBtn.innerHTML = "‚ñ∂Ô∏è PLAY";
            document.getElementById('waveformModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function drawForensicWaveform() {
            if (!canvas) return;
            const width = canvas.width;
            const height = canvas.height;

            if (!forensicPeaks || forensicPeaks.length <= 1) {
                // Fallback: No hay picos, dibujar solo el mensaje y la l√≠nea de tiempo si est√° reproduciendo
                ctx.clearRect(0, 0, width, height);
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.font = '14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('Sin datos de onda ‚Äî Pulsa PLAY para reproducir', width / 2, height / 2 + 5);
                ctx.textAlign = 'left';

                if (forensicAudio && forensicDuration > 0 && !isNaN(forensicAudio.currentTime)) {
                    const currentPlayX = (forensicAudio.currentTime / forensicDuration) * width;
                    ctx.fillStyle = 'white';
                    ctx.fillRect(currentPlayX - 1, 0, 3, 10);
                    ctx.fillRect(currentPlayX - 1, height - 10, 3, 10);
                }
                return;
            }

            ctx.clearRect(0, 0, width, height);

            const localMax = Math.max(...forensicPeaks, 100);
            const maxPcm = localMax;

            // Grid (Centro, Techo, Suelo)
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.beginPath();
            ctx.moveTo(0, height / 2); ctx.lineTo(width, height / 2);
            ctx.moveTo(0, 0); ctx.lineTo(width, 0);
            ctx.moveTo(0, height); ctx.lineTo(width, height);
            ctx.stroke();

            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.font = '10px monospace';
            ctx.textAlign = 'left';
            ctx.fillText('+' + maxPcm, 2, 10);
            ctx.fillText('0', 2, (height / 2) - 2);
            ctx.fillText('-' + maxPcm, 2, height - 2);

            const step = width / forensicPeaks.length;
            const currentPlayX = (forensicAudio && forensicDuration > 0 && !isNaN(forensicAudio.currentTime)) ? (forensicAudio.currentTime / forensicDuration) * width : 0;

            for (let i = 0; i < forensicPeaks.length; i++) {
                const normalized = forensicPeaks[i] / localMax;
                const barHeight = Math.max(1, normalized * height);
                const x = i * step;
                const y = (height - barHeight) / 2;

                ctx.fillStyle = x <= currentPlayX ? '#d32f2f' : '#4caf50';
                ctx.fillRect(x, y, Math.max(1, step - 0.5), barHeight);
            }

            ctx.fillStyle = 'white';
            ctx.fillRect(currentPlayX - 1, 0, 3, 10);
            ctx.fillRect(currentPlayX - 1, height - 10, 3, 10);
        }

        function initForensicAudio() {
            // Crear el <audio> con sus listeners (llamar SOLO dentro de gesto de usuario)
            forensicAudio = new Audio(forensicAudioUrl);
            forensicAudio.setAttribute('playsinline', '');
            forensicAudio.ontimeupdate = function () {
                if (!isDragging) {
                    drawForensicWaveform();
                    updateWaveTimeDisplay();
                }
            };
            forensicAudio.onended = function () {
                isWavePlaying = false;
                wavePlayBtn.innerHTML = '‚ñ∂Ô∏è PLAY';
                drawForensicWaveform();
            };
            forensicAudio.onloadedmetadata = function () {
                // Actualizar duraci√≥n si venimos de un fallback (peaks.length <= 1 o duration <= 1)
                if (forensicDuration <= 1 || isNaN(forensicDuration) || forensicPeaks.length <= 1) {
                    forensicDuration = forensicAudio.duration;
                    drawForensicWaveform();
                    updateWaveTimeDisplay();
                }
                waveLoading.style.display = 'none';
            };
            forensicAudio.onerror = function () {
                console.error('Error audio forense');
                waveLoading.style.display = 'none';
            };
        }

        function toggleWaveformPlay() {
            if (!forensicAudioUrl) return;
            if (isWavePlaying) {
                if (forensicAudio) forensicAudio.pause();
                isWavePlaying = false;
                wavePlayBtn.innerHTML = '‚ñ∂Ô∏è PLAY';
            } else {
                // Safari iOS: crear Audio + play() en un UNICO gesto at√≥mico
                if (!forensicAudio) initForensicAudio();
                wavePlayBtn.innerHTML = '‚è≥ CARGANDO...';
                try {
                    var p = forensicAudio.play();
                    if (p && p.then) {
                        p.then(function () {
                            isWavePlaying = true;
                            wavePlayBtn.innerHTML = '‚è∏ PAUSE';
                        }).catch(function (e) {
                            console.error('Play error:', e.name, e.message);
                            wavePlayBtn.innerHTML = '‚ñ∂Ô∏è PLAY';
                        });
                    } else {
                        isWavePlaying = true;
                        wavePlayBtn.innerHTML = '‚è∏ PAUSE';
                    }
                } catch (ex) {
                    console.error('Play exception:', ex);
                    wavePlayBtn.innerHTML = '‚ñ∂Ô∏è PLAY';
                }
            }
        }

        function seekWaveform(seconds) {
            if (!forensicAudio) return;
            let newTime = forensicAudio.currentTime + seconds;
            if (newTime < 0) newTime = 0;
            if (newTime > forensicDuration) newTime = forensicDuration;
            forensicAudio.currentTime = newTime;
            drawForensicWaveform();
            updateWaveTimeDisplay();
        }

        function updateWaveTimeDisplay() {
            if (!forensicAudio) return;
            const formatTime = (time) => {
                const h = Math.floor(time / 3600);
                const m = Math.floor((time % 3600) / 60).toString().padStart(2, '0');
                const s = Math.floor(time % 60).toString().padStart(2, '0');
                return h > 0 ? `${h}:${m}:${s}` : `${m}:${s}`;
            };
            waveTimeDisplay.innerText = `${formatTime(forensicAudio ? forensicAudio.currentTime : 0)} / ${formatTime(forensicDuration)}`;
        }

        // --- L√ìGICA DE SCRUBBING ---
        let isDragging = false;
        function handlePointerDown(e) {
            if (!forensicAudio) return;
            isDragging = true;
            handlePointerMove(e);
        }
        function handlePointerMove(e) {
            if (!isDragging || !forensicAudio || forensicDuration === 0) return;
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let ratio = (clientX - rect.left) / rect.width;
            ratio = Math.max(0, Math.min(ratio, 1));

            forensicAudio.currentTime = ratio * forensicDuration;
            drawForensicWaveform();
            updateWaveTimeDisplay();
        }
        function handlePointerUp() {
            isDragging = false;
        }

        canvas.addEventListener('mousedown', handlePointerDown);
        canvas.addEventListener('mousemove', handlePointerMove);
        canvas.addEventListener('mouseup', handlePointerUp);
        canvas.addEventListener('mouseleave', handlePointerUp);
        canvas.addEventListener('touchstart', handlePointerDown, { passive: true });
        canvas.addEventListener('touchmove', handlePointerMove, { passive: true });
        canvas.addEventListener('touchend', handlePointerUp);

        // --- L√≥gica de Arrastre de Umbral (V59) ---
        let isDraggingThreshold = false;
        const vContainer = document.querySelector('.meter-bg');
        const tMarker = document.querySelector('.threshold-marker');
        const tLabel = document.getElementById('thresholdLabel');

        if (tMarker && vContainer) {
            tMarker.addEventListener('pointerdown', (e) => {
                isDraggingThreshold = true;
                tMarker.setPointerCapture(e.pointerId);
            });

            tMarker.addEventListener('pointermove', (e) => {
                if (!isDraggingThreshold) return;
                const rect = vContainer.getBoundingClientRect();
                let x = e.clientX - rect.left;
                let percent = Math.max(0, Math.min(x, rect.width)) / rect.width;
                let newThresh = Math.round(percent * 32767);

                tMarker.style.left = (percent * 100) + '%';
                if (tLabel) tLabel.innerText = newThresh;
            });

            tMarker.addEventListener('pointerup', (e) => {
                if (!isDraggingThreshold) return;
                isDraggingThreshold = false;
                tMarker.releasePointerCapture(e.pointerId);

                const rect = vContainer.getBoundingClientRect();
                let x = e.clientX - rect.left;
                let percent = Math.max(0, Math.min(x, rect.width)) / rect.width;
                let finalThresh = Math.round(percent * 32767);

                // Actualizaci√≥n optimista
                if (latestConfig) latestConfig.SPIKE_THRESHOLD = finalThresh;

                fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ SPIKE_THRESHOLD: finalThresh })
                }).then(res => res.json()).then(data => {
                    updateDashboard();
                }).catch(err => console.error("Error guardando umbral", err));
            });
        }

        // --- MOTOR DE EXPORTACI√ìN H√çBRIDO ---
        async function exportAudio(fileName, btnElement) {
            const url = '/api/audio?file=' + encodeURIComponent(fileName);
            const oldText = btnElement.innerHTML;
            btnElement.innerHTML = '‚è≥...';
            btnElement.disabled = true;

            try {
                // 1. Descargar el archivo al navegador como Blob
                const response = await fetch(url);
                const blob = await response.blob();
                let shared = false;

                // 2. Intentar Web Share API (Nativo en iOS)
                if (navigator.canShare) {
                    const file = new File([blob], fileName, { type: 'audio/aac' }); // Usar MIME aac para coincidir con WebServer
                    if (navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: 'Grabaci√≥n de El O√≠do del Abuelo',
                            files: [file]
                        });
                        shared = true;
                    }
                }

                // 3. Fallback: Descarga cl√°sica si el navegador no soporta Share
                if (!shared) {
                    const downloadUrl = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = downloadUrl;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);
                }
            } catch (err) {
                if (err.name !== 'AbortError' && err.name !== 'NotAllowedError') { // Ignorar cancelaciones de usuario
                    console.error("Error exportando audio", err);
                    alert("No se pudo exportar el archivo.");
                }
            } finally {
                btnElement.innerHTML = oldText;
                btnElement.disabled = false;
            }
        }

        // Polling agresivo para sensaci√≥n de tiempo real fluido en Dashboard general
        setInterval(updateDashboard, 200);

        // Cargar historial al iniciar
        loadHistory();
    </script>

</body>

</html>