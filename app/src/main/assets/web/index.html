<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando - O√≠do del Abuelo</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1f1f1f;
            --text-color: #ffffff;
            --text-muted: #888888;
            --primary-color: #d32f2f;
            --primary-dark: #9a0007;
            --status-green: #03dac6;
            --status-yellow: #ffb300;
            --status-red: #d32f2f;
            --status-gray: #757575;
            --item-bg: #2c2c2c;
            --item-active: #3d3d3d;
            --max-amplitude: 32767;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dashboard {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        h1 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
            letter-spacing: 1px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background-color: var(--status-gray);
            color: #fff;
        }

        .instrument-panel {
            margin-bottom: 20px;
            text-align: left;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meter-bg {
            width: 100%;
            height: 30px;
            background-color: #333;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            width: 0%;
            background-color: var(--status-green);
            transition: width 0.1s linear, background-color 0.2s ease;
        }

        .threshold-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: rgba(255, 255, 255, 0.3);
            left: calc((10000 / 32767) * 100%);
            /* 10000 is default SPIKE_THRESHOLD */
            z-index: 10;
        }

        .threshold-marker::after {
            content: "Umbral";
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .settings-btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .settings-btn:hover {
            opacity: 0.8;
            background-color: var(--primary-dark);
        }

        /* LIVE BUTTON PULSE ANIMATION (El Ojo Style) */
        .live-btn-active {
            background-color: var(--status-red) !important;
            color: white !important;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7);
            }

            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(211, 47, 47, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(211, 47, 47, 0);
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #222222;
            padding: 25px;
            border-radius: 12px;
            width: 85%;
            max-width: 400px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--status-green);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .form-group input[type="number"],
        .form-group input[type="range"] {
            width: 100%;
            box-sizing: border-box;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
        }

        .form-group input[type="checkbox"] {
            transform: scale(1.2);
        }

        .btn-row {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-save {
            background: #2e7d32;
            color: white;
            flex: 1;
            margin-right: 10px;
        }

        .btn-close {
            background: #c62828;
            color: white;
            flex: 1;
        }

        .history-panel {
            margin-top: 30px;
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: left;
        }

        .history-card {
            background-color: var(--item-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            border-left: 4px solid var(--status-gray);
            /* Cambiar√° din√°micamente */
            transition: transform 0.1s, background-color 0.2s;
        }

        .history-card:active {
            transform: scale(0.98);
            background-color: var(--item-active);
        }

        .history-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: bold;
            font-size: 0.95rem;
            color: #fff;
        }

        .history-size {
            font-size: 0.8rem;
            color: #aaa;
        }

        audio {
            width: 100%;
            height: 35px;
            outline: none;
            border-radius: 20px;
        }
    </style>
</head>

<body>

    <div class="dashboard">
        <h1>El O√≠do del Abuelo <span id="appVersion" style="font-size: 0.8rem; color: var(--status-gray);"></span></h1>
        <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Ajustes</button>

        <!-- HARDWARE TELEMETRY TOOLBAR -->
        <div id="telemetryToolbar"
            style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 5px auto 15px auto; background: rgba(255, 255, 255, 0.05); padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(4px); font-size: 0.85rem; font-weight: bold; width: fit-content; transition: all 0.3s;">
            <div style="display: flex; align-items: center; gap: 5px;">
                <span id="batteryIcon" style="transition: color 0.3s; font-size: 1.1rem;">üîã</span>
                <span id="batteryText" style="transition: color 0.3s; color: #fff;">--%</span>
            </div>
            <div style="width: 1px; height: 15px; background: rgba(255,255,255,0.2);"></div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <span id="tempIcon" style="transition: color 0.3s; font-size: 1.1rem;">üå°Ô∏è</span>
                <span id="tempText" style="transition: color 0.3s; color: #fff;">--¬∞C</span>
            </div>
        </div>

        <br>
        <div id="statusBadge" class="status-badge">Conectando...</div>

        <div class="instrument-panel">
            <button id="btnLive" class="settings-btn"
                style="background-color: var(--status-gray); display: block; width: 100%; margin-top: 10px; margin-bottom: 30px; text-align: center; font-size: 1.1rem; padding: 15px;"
                onclick="toggleLiveAudio()">üìª Escuchar en Vivo (OFF)</button>
            <div class="label-row">
                <span>Amplitud de Micr√≥fono</span>
                <span id="amplitudeValue">0</span>
            </div>
            <div class="meter-bg">
                <div id="vumeter" class="meter-fill"></div>
                <div class="threshold-marker"></div>
            </div>
        </div>
    </div>

    <div class="history-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin: 0; color: var(--primary-color);">Historial de Alertas</h2>
            <button class="settings-btn" style="margin: 0;" onclick="loadHistory()">üîÑ Actualizar</button>
        </div>
        <div id="historyContainer">
            <p style="text-align: center; color: #888; font-size: 0.9rem;">Cargando historial...</p>
        </div>
    </div>

    <!-- Modal de Ajustes -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Ajustes del Centinela</h2>
            <div class="form-group">
                <label><input type="checkbox" id="inpDetection"> DETECTION_ENABLED (Standby)</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="inpShield"> SHIELD_ENABLED (Escudo)</label>
            </div>
            <div class="form-group">
                <label>SPIKE_THRESHOLD: <span id="valSpike">10000</span></label>
                <input type="range" id="inpSpike" min="0" max="32767" value="10000"
                    oninput="document.getElementById('valSpike').innerText=this.value">
            </div>
            <div class="form-group">
                <label>REQUIRED_SPIKES (Picos para Alarma)</label>
                <input type="number" id="inpRequired" min="1" max="10">
            </div>
            <div class="form-group">
                <label>SHIELD_WINDOW_MS (Ventana de Tolerancia MS)</label>
                <input type="number" id="inpWindow" min="100" max="5000">
            </div>
            <div class="form-group">
                <label>RECORD_DURATION_MS (Duraci√≥n Grabaci√≥n MS)</label>
                <input type="number" id="inpDuration" min="1000" max="60000">
            </div>
            <div class="form-group" style="margin-top: 20px; border-top: 1px solid #444; padding-top: 20px;">
                <label style="color: var(--status-red); font-weight: bold;">‚ö†Ô∏è ZONA DE PELIGRO</label>
                <button class="btn" style="background: var(--status-red); color: white; width: 100%; margin-top: 10px;"
                    onclick="deleteRecordings()">üóëÔ∏è Purgar Todo el Historial</button>
            </div>
            <div class="btn-row">
                <button class="btn btn-close" onclick="closeSettings()">Cancelar</button>
                <button class="btn btn-save" onclick="saveSettings()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const MAX_AMPLITUDE = 32767;
        let latestConfig = {};

        // Reproducci√≥n exclusiva: Detener otros audios al reproducir uno nuevo
        document.addEventListener('play', function (e) {
            if (e.target.tagName === 'AUDIO') {
                // Pausar cualquier otro audio del historial
                document.querySelectorAll('audio').forEach(function (audioElement) {
                    if (audioElement !== e.target) {
                        audioElement.pause();
                    }
                });

                // Apagar el stream en vivo si estaba sonando
                if (liveAudio != null) {
                    toggleLiveAudio();
                }
            }
        }, true); // Usar fase de captura porque los eventos media no burbujean

        const vumeter = document.getElementById('vumeter');
        const statusBadge = document.getElementById('statusBadge');
        const amplitudeValue = document.getElementById('amplitudeValue');

        function updateDashboard() {
            fetch('/api/status')
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    const amp = data.currentAmplitude || 0;
                    const isRecording = data.isRecording;
                    const detectionEnabled = data.DETECTION_ENABLED;

                    latestConfig = data; // Almacenamos para rellenar el modal

                    if (data.version) {
                        document.getElementById('appVersion').textContent = data.version;
                        document.title = "El O√≠do del Abuelo - " + data.version;
                    }

                    // Hardware Telemetry
                    if (data.batteryPct !== undefined && data.tempCelsius !== undefined) {
                        const batText = document.getElementById('batteryText');
                        const batIcon = document.getElementById('batteryIcon');
                        const tempText = document.getElementById('tempText');
                        const tempIcon = document.getElementById('tempIcon');

                        batText.textContent = data.batteryPct + "%" + (data.isCharging ? " (AC)" : "");
                        if (data.isCharging) {
                            batText.style.color = "var(--status-green)";
                            batIcon.textContent = "‚ö°";
                        } else if (data.batteryPct <= 20) {
                            batText.style.color = "var(--status-red)";
                            batIcon.textContent = "ü™´";
                        } else {
                            batText.style.color = "#fff";
                            batIcon.textContent = "üîã";
                        }

                        tempText.textContent = data.tempCelsius.toFixed(1) + "¬∞C";
                        if (data.tempCelsius > 40) {
                            tempText.style.color = "var(--status-red)";
                            tempIcon.style.color = "var(--status-red)";
                        } else if (data.tempCelsius > 35) {
                            tempText.style.color = "orange";
                            tempIcon.style.color = "orange";
                        } else {
                            tempText.style.color = "#fff";
                            tempIcon.style.color = "inherit";
                        }
                    }

                    // Ajustar UI del threshold-marker
                    let currentSpikeThreshold = (data.SPIKE_THRESHOLD !== undefined) ? data.SPIKE_THRESHOLD : 10000;
                    document.querySelector('.threshold-marker').style.left = `calc((${currentSpikeThreshold} / 32767) * 100%)`;

                    // Actualizar texto num√©rico
                    amplitudeValue.textContent = Math.round(amp);

                    // Calcular porcentaje para ancho CSS
                    let percentage = (amp / MAX_AMPLITUDE) * 100;
                    if (percentage > 100) percentage = 100;
                    vumeter.style.width = percentage + '%';

                    // L√≥gica de colores y estados
                    if (!detectionEnabled) {
                        statusBadge.textContent = "Standby";
                        statusBadge.style.backgroundColor = "var(--status-gray)";
                        vumeter.style.backgroundColor = "var(--status-gray)";
                    } else if (isRecording) {
                        statusBadge.textContent = "Grabando Alarma";
                        statusBadge.style.backgroundColor = "var(--status-red)";
                        vumeter.style.backgroundColor = "var(--status-red)";
                    } else {
                        statusBadge.textContent = "Vigilando";
                        statusBadge.style.backgroundColor = "var(--primary-dark)";

                        // V√∫metro din√°mico en escucha
                        if (amp > currentSpikeThreshold) {
                            vumeter.style.backgroundColor = "var(--status-red)";
                        } else {
                            vumeter.style.backgroundColor = "var(--status-green)";
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    statusBadge.textContent = "Sin Conexi√≥n";
                    statusBadge.style.backgroundColor = "var(--status-gray)";
                    vumeter.style.width = '0%';
                });
        }

        function openSettings() {
            document.getElementById('inpDetection').checked = latestConfig.DETECTION_ENABLED ?? true;
            document.getElementById('inpShield').checked = latestConfig.SHIELD_ENABLED ?? true;
            document.getElementById('inpSpike').value = latestConfig.SPIKE_THRESHOLD ?? 10000;
            document.getElementById('valSpike').innerText = latestConfig.SPIKE_THRESHOLD ?? 10000;
            document.getElementById('inpRequired').value = latestConfig.REQUIRED_SPIKES ?? 3;
            document.getElementById('inpWindow').value = latestConfig.SHIELD_WINDOW_MS ?? 500;
            document.getElementById('inpDuration').value = latestConfig.RECORD_DURATION_MS ?? 15000;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const payload = {
                DETECTION_ENABLED: document.getElementById('inpDetection').checked,
                SHIELD_ENABLED: document.getElementById('inpShield').checked,
                SPIKE_THRESHOLD: parseInt(document.getElementById('inpSpike').value),
                REQUIRED_SPIKES: parseInt(document.getElementById('inpRequired').value),
                SHIELD_WINDOW_MS: parseInt(document.getElementById('inpWindow').value),
                RECORD_DURATION_MS: parseInt(document.getElementById('inpDuration').value)
            };

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        closeSettings();
                        updateDashboard();
                    } else {
                        alert("Error guardando: " + data.message);
                    }
                })
                .catch(err => alert("Error de red al guardar"));
        }

        function deleteRecordings() {
            if (!confirm("‚ö†Ô∏è ¬øPulsar el Bot√≥n del P√°nico? Se borrar√° TODO el historial permanentemente.")) return;

            fetch('/api/recordings', { method: 'DELETE' })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        loadHistory();
                    } else {
                        alert("Error borrando: " + data.message);
                    }
                });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function loadHistory() {
            fetch('/api/recordings')
                .then(r => r.json())
                .then(files => {
                    const list = document.getElementById('historyContainer');
                    list.innerHTML = '';
                    if (files.length === 0) {
                        list.innerHTML = '<div style="text-align:center; color:#888;">No hay grabaciones todav√≠a.</div>';
                        return;
                    }

                    files.forEach(f => {
                        const card = document.createElement('div');
                        card.className = 'history-card';

                        // Todo es rojo carmes√≠ base ya que WebServer no env√≠a maxAmplitude
                        card.style.borderLeftColor = 'var(--status-red)';

                        const dateObj = new Date(f.timestamp);
                        const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();

                        // Formatear tama√±o a KB o MB
                        const sizeKB = f.size / 1024;
                        const sizeStr = sizeKB > 1024 ? (sizeKB / 1024).toFixed(2) + ' MB' : sizeKB.toFixed(1) + ' KB';

                        card.innerHTML = `
                            <div class="history-card-header">
                                <span class="history-date">üö® ${dateStr}</span>
                                <span class="history-size">üìÅ ${sizeStr}</span>
                            </div>
                            <audio controls preload="none">
                                <source src="/api/audio?file=${encodeURIComponent(f.name)}" type="audio/wav">
                                Tu navegador no soporta la etiqueta de audio.
                            </audio>
                        `;
                        list.appendChild(card);
                    });
                })
                .catch(err => {
                    console.error("Error cargando historial:", err);
                    const list = document.getElementById('historyContainer');
                    list.innerHTML = '<p style="text-align: center; color: var(--status-red); font-size: 0.9rem;">Error de conexi√≥n.</p>';
                });
        }

        let liveAudio = null; // Mantenemos para compatibilidad de nombre, pero ser√° nuestro AudioContext
        let abortController = null;
        let nextPlayTime = 0;

        async function playLiveStream() {
            try {
                liveAudio = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                abortController = new AbortController();
                nextPlayTime = liveAudio.currentTime;

                const response = await fetch('/api/stream', { signal: abortController.signal });
                const reader = response.body.getReader();

                let isHeaderSkipped = false;
                let bufferData = new Uint8Array(0);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // Acumular fragmentos en buffer
                    const newBuffer = new Uint8Array(bufferData.length + value.length);
                    newBuffer.set(bufferData);
                    newBuffer.set(value, bufferData.length);
                    bufferData = newBuffer;

                    // Decapitar 44 bytes de cabecera solo en el primer trozo
                    if (!isHeaderSkipped && bufferData.length >= 44) {
                        bufferData = bufferData.slice(44);
                        isHeaderSkipped = true;
                    }

                    // Asegurarnos de tener un n√∫mero par de bytes (16-bit = 2 bytes)
                    if (isHeaderSkipped && bufferData.length >= 2) {
                        const bytesToProcess = bufferData.length - (bufferData.length % 2);
                        const chunkBytes = bufferData.slice(0, bytesToProcess);
                        bufferData = bufferData.slice(bytesToProcess);

                        // Convertir PCM 16-bit Little Endian a Float32 (Web Audio API estandar)
                        const samples = new Float32Array(chunkBytes.length / 2);
                        const dataView = new DataView(chunkBytes.buffer);
                        for (let i = 0; i < samples.length; i++) {
                            const int16 = dataView.getInt16(i * 2, true);
                            samples[i] = int16 / 32768.0; // Normalizar a [-1.0, 1.0]
                        }

                        // Crear AudioBuffer e inyectar
                        const audioBuffer = liveAudio.createBuffer(1, samples.length, 16000);
                        audioBuffer.getChannelData(0).set(samples);

                        const source = liveAudio.createBufferSource();
                        source.buffer = audioBuffer;
                        source.connect(liveAudio.destination);

                        // Si el tiempo de reproducci√≥n previsto se qued√≥ atr√°s (latencia / CPU)
                        if (nextPlayTime < liveAudio.currentTime) {
                            nextPlayTime = liveAudio.currentTime;
                        }

                        source.start(nextPlayTime);
                        nextPlayTime += audioBuffer.duration;
                    }
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error("Error en streaming:", err);
                    stopLiveStream();
                }
            }
        }

        function stopLiveStream() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            if (liveAudio) {
                liveAudio.close();
                liveAudio = null;
            }
            const btn = document.getElementById('btnLive');
            btn.textContent = "üìª Escuchar en Vivo (OFF)";
            btn.classList.remove('live-btn-active');
        }

        function toggleLiveAudio() {
            const btn = document.getElementById('btnLive');
            if (liveAudio == null) {
                // Pausar cualquier audio del historial
                document.querySelectorAll('audio').forEach(a => a.pause());

                playLiveStream();
                btn.textContent = "üìª Escuchar en Vivo (ON)";
                btn.classList.add('live-btn-active');
            } else {
                stopLiveStream();
            }
        }

        // Polling agresivo para sensaci√≥n de tiempo real fluido
        setInterval(updateDashboard, 200);

        // Cargar historial al iniciar
        loadHistory();
    </script>

</body>

</html>