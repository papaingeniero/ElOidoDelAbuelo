<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Mando - O铆do del Abuelo</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e0e0e0;
            --primary-color: #bb86fc;
            --status-green: #03dac6;
            --status-yellow: #ffb300;
            --status-red: #cf6679;
            --status-gray: #757575;
            --max-amplitude: 32767;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dashboard {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 30px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        h1 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
            letter-spacing: 1px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background-color: var(--status-gray);
            color: #fff;
        }

        .instrument-panel {
            margin-bottom: 20px;
            text-align: left;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meter-bg {
            width: 100%;
            height: 30px;
            background-color: #333;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .meter-fill {
            height: 100%;
            width: 0%;
            background-color: var(--status-green);
            transition: width 0.1s linear, background-color 0.2s ease;
        }

        .threshold-marker {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: rgba(255, 255, 255, 0.3);
            left: calc((10000 / 32767) * 100%);
            /* 10000 is default SPIKE_THRESHOLD */
            z-index: 10;
        }

        .threshold-marker::after {
            content: "Umbral";
            position: absolute;
            top: -20px;
            left: -20px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .settings-btn {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-bottom: 20px;
            font-weight: bold;
            transition: opacity 0.2s;
        }

        .settings-btn:hover {
            opacity: 0.8;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: left;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .form-group input[type="number"],
        .form-group input[type="range"] {
            width: 100%;
            box-sizing: border-box;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
        }

        .form-group input[type="checkbox"] {
            transform: scale(1.2);
        }

        .btn-row {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-save {
            background: var(--status-green);
            color: #000;
        }

        .btn-close {
            background: #555;
            color: #fff;
        }

        .history-panel {
            margin-top: 30px;
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: left;
        }

        .history-card {
            background-color: #2c2c2c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            border-left: 4px solid var(--status-red);
        }

        .history-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .history-date {
            font-weight: bold;
            font-size: 0.95rem;
            color: #fff;
        }

        .history-size {
            font-size: 0.8rem;
            color: #aaa;
        }

        audio {
            width: 100%;
            height: 35px;
            outline: none;
            border-radius: 20px;
        }
    </style>
</head>

<body>

    <div class="dashboard">
        <h1>El O铆do del Abuelo <span id="appVersion" style="font-size: 0.8rem; color: var(--status-gray);"></span></h1>
        <button class="settings-btn" onclick="openSettings()">锔 Ajustes</button>
        <br>
        <div id="statusBadge" class="status-badge">Conectando...</div>

        <div class="instrument-panel">
            <button id="btnLive" class="settings-btn"
                style="background-color: var(--status-gray); display: block; width: 100%; margin-top: 10px; margin-bottom: 30px; text-align: center; font-size: 1.1rem; padding: 15px;"
                onclick="toggleLiveAudio()"> Escuchar en Vivo (OFF)</button>
            <div class="label-row">
                <span>Amplitud de Micr贸fono</span>
                <span id="amplitudeValue">0</span>
            </div>
            <div class="meter-bg">
                <div id="vumeter" class="meter-fill"></div>
                <div class="threshold-marker"></div>
            </div>
        </div>
    </div>

    <div class="history-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h2 style="margin: 0; color: var(--primary-color);">Historial de Alertas</h2>
            <button class="settings-btn" style="margin: 0;" onclick="loadHistory()"> Actualizar</button>
        </div>
        <div id="historyContainer">
            <p style="text-align: center; color: #888; font-size: 0.9rem;">Cargando historial...</p>
        </div>
    </div>

    <!-- Modal de Ajustes -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <h2>Ajustes del Centinela</h2>
            <div class="form-group">
                <label><input type="checkbox" id="inpDetection"> DETECTION_ENABLED (Standby)</label>
            </div>
            <div class="form-group">
                <label><input type="checkbox" id="inpShield"> SHIELD_ENABLED (Escudo)</label>
            </div>
            <div class="form-group">
                <label>SPIKE_THRESHOLD: <span id="valSpike">10000</span></label>
                <input type="range" id="inpSpike" min="0" max="32767" value="10000"
                    oninput="document.getElementById('valSpike').innerText=this.value">
            </div>
            <div class="form-group">
                <label>REQUIRED_SPIKES (Picos para Alarma)</label>
                <input type="number" id="inpRequired" min="1" max="10">
            </div>
            <div class="form-group">
                <label>SHIELD_WINDOW_MS (Ventana de Tolerancia MS)</label>
                <input type="number" id="inpWindow" min="100" max="5000">
            </div>
            <div class="form-group">
                <label>RECORD_DURATION_MS (Duraci贸n Grabaci贸n MS)</label>
                <input type="number" id="inpDuration" min="1000" max="60000">
            </div>
            <div class="btn-row">
                <button class="btn btn-close" onclick="closeSettings()">Cancelar</button>
                <button class="btn btn-save" onclick="saveSettings()">Guardar</button>
            </div>
        </div>
    </div>

    <script>
        const MAX_AMPLITUDE = 32767;
        let latestConfig = {};

        // Reproducci贸n exclusiva: Detener otros audios al reproducir uno nuevo
        document.addEventListener('play', function (e) {
            if (e.target.tagName === 'AUDIO') {
                // Pausar cualquier otro audio del historial
                document.querySelectorAll('audio').forEach(function (audioElement) {
                    if (audioElement !== e.target) {
                        audioElement.pause();
                    }
                });

                // Apagar el stream en vivo si estaba sonando
                if (liveAudio != null) {
                    toggleLiveAudio();
                }
            }
        }, true); // Usar fase de captura porque los eventos media no burbujean

        const vumeter = document.getElementById('vumeter');
        const statusBadge = document.getElementById('statusBadge');
        const amplitudeValue = document.getElementById('amplitudeValue');

        function updateDashboard() {
            fetch('/api/status')
                .then(response => {
                    if (!response.ok) throw new Error("Network response was not ok");
                    return response.json();
                })
                .then(data => {
                    const amp = data.currentAmplitude || 0;
                    const isRecording = data.isRecording;
                    const detectionEnabled = data.DETECTION_ENABLED;

                    latestConfig = data; // Almacenamos para rellenar el modal

                    if (data.version) {
                        document.getElementById('appVersion').textContent = data.version;
                        document.title = "El O铆do del Abuelo - " + data.version;
                    }

                    // Ajustar UI del threshold-marker
                    let currentSpikeThreshold = (data.SPIKE_THRESHOLD !== undefined) ? data.SPIKE_THRESHOLD : 10000;
                    document.querySelector('.threshold-marker').style.left = `calc((${currentSpikeThreshold} / 32767) * 100%)`;

                    // Actualizar texto num茅rico
                    amplitudeValue.textContent = Math.round(amp);

                    // Calcular porcentaje para ancho CSS
                    let percentage = (amp / MAX_AMPLITUDE) * 100;
                    if (percentage > 100) percentage = 100;
                    vumeter.style.width = percentage + '%';

                    // L贸gica de colores y estados
                    if (!detectionEnabled) {
                        statusBadge.textContent = "Standby";
                        statusBadge.style.backgroundColor = "var(--status-gray)";
                        vumeter.style.backgroundColor = "var(--status-gray)";
                    } else if (isRecording) {
                        statusBadge.textContent = "Grabando Alarma";
                        statusBadge.style.backgroundColor = "var(--status-red)";
                        vumeter.style.backgroundColor = "var(--status-red)";
                    } else {
                        statusBadge.textContent = "Escuchando";
                        statusBadge.style.backgroundColor = "var(--status-green)";

                        // V煤metro din谩mico en escucha
                        if (amp > currentSpikeThreshold) {
                            vumeter.style.backgroundColor = "var(--status-yellow)";
                        } else {
                            vumeter.style.backgroundColor = "var(--status-green)";
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    statusBadge.textContent = "Sin Conexi贸n";
                    statusBadge.style.backgroundColor = "var(--status-gray)";
                    vumeter.style.width = '0%';
                });
        }

        function openSettings() {
            document.getElementById('inpDetection').checked = latestConfig.DETECTION_ENABLED ?? true;
            document.getElementById('inpShield').checked = latestConfig.SHIELD_ENABLED ?? true;
            document.getElementById('inpSpike').value = latestConfig.SPIKE_THRESHOLD ?? 10000;
            document.getElementById('valSpike').innerText = latestConfig.SPIKE_THRESHOLD ?? 10000;
            document.getElementById('inpRequired').value = latestConfig.REQUIRED_SPIKES ?? 3;
            document.getElementById('inpWindow').value = latestConfig.SHIELD_WINDOW_MS ?? 500;
            document.getElementById('inpDuration').value = latestConfig.RECORD_DURATION_MS ?? 15000;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function saveSettings() {
            const payload = {
                DETECTION_ENABLED: document.getElementById('inpDetection').checked,
                SHIELD_ENABLED: document.getElementById('inpShield').checked,
                SPIKE_THRESHOLD: parseInt(document.getElementById('inpSpike').value),
                REQUIRED_SPIKES: parseInt(document.getElementById('inpRequired').value),
                SHIELD_WINDOW_MS: parseInt(document.getElementById('inpWindow').value),
                RECORD_DURATION_MS: parseInt(document.getElementById('inpDuration').value)
            };

            fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        closeSettings();
                    } else {
                        alert('Error al guardar: ' + data.status);
                    }
                })
                .catch(err => {
                    alert('Error de red al guardar ajustes.');
                    console.error(err);
                });
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function loadHistory() {
            const container = document.getElementById('historyContainer');
            container.innerHTML = '<p style="text-align: center; color: #888; font-size: 0.9rem;">Cargando historial...</p>';

            fetch('/api/recordings')
                .then(res => res.json())
                .then(data => {
                    container.innerHTML = '';
                    if (data.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #888; font-size: 0.9rem;">No hay alertas registradas todav铆a.</p>';
                        return;
                    }

                    data.forEach(item => {
                        const dateObj = new Date(item.timestamp);
                        const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();

                        const card = document.createElement('div');
                        card.className = 'history-card';
                        card.innerHTML = `
                            <div class="history-card-header">
                                <span class="history-date"> Alerta: ${dateStr}</span>
                                <span class="history-size">${formatBytes(item.size)}</span>
                            </div>
                            <audio controls src="/api/audio?file=${encodeURIComponent(item.name)}" preload="none"></audio>
                        `;
                        container.appendChild(card);
                    });
                })
                .catch(err => {
                    console.error("Error cargando historial:", err);
                    container.innerHTML = '<p style="text-align: center; color: var(--status-red); font-size: 0.9rem;">Error de conexi贸n.</p>';
                });
        }

        let liveAudio = null; // Mantenemos para compatibilidad de nombre, pero ser谩 nuestro AudioContext
        let abortController = null;
        let nextPlayTime = 0;

        async function playLiveStream() {
            try {
                liveAudio = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
                abortController = new AbortController();
                nextPlayTime = liveAudio.currentTime;

                const response = await fetch('/api/stream', { signal: abortController.signal });
                const reader = response.body.getReader();

                let isHeaderSkipped = false;
                let bufferData = new Uint8Array(0);

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // Acumular fragmentos en buffer
                    const newBuffer = new Uint8Array(bufferData.length + value.length);
                    newBuffer.set(bufferData);
                    newBuffer.set(value, bufferData.length);
                    bufferData = newBuffer;

                    // Decapitar 44 bytes de cabecera solo en el primer trozo
                    if (!isHeaderSkipped && bufferData.length >= 44) {
                        bufferData = bufferData.slice(44);
                        isHeaderSkipped = true;
                    }

                    // Asegurarnos de tener un n煤mero par de bytes (16-bit = 2 bytes)
                    if (isHeaderSkipped && bufferData.length >= 2) {
                        const bytesToProcess = bufferData.length - (bufferData.length % 2);
                        const chunkBytes = bufferData.slice(0, bytesToProcess);
                        bufferData = bufferData.slice(bytesToProcess);

                        // Convertir PCM 16-bit Little Endian a Float32 (Web Audio API estandar)
                        const samples = new Float32Array(chunkBytes.length / 2);
                        const dataView = new DataView(chunkBytes.buffer);
                        for (let i = 0; i < samples.length; i++) {
                            const int16 = dataView.getInt16(i * 2, true);
                            samples[i] = int16 / 32768.0; // Normalizar a [-1.0, 1.0]
                        }

                        // Crear AudioBuffer e inyectar
                        const audioBuffer = liveAudio.createBuffer(1, samples.length, 16000);
                        audioBuffer.getChannelData(0).set(samples);

                        const source = liveAudio.createBufferSource();
                        source.buffer = audioBuffer;
                        source.connect(liveAudio.destination);

                        // Si el tiempo de reproducci贸n previsto se qued贸 atr谩s (latencia / CPU)
                        if (nextPlayTime < liveAudio.currentTime) {
                            nextPlayTime = liveAudio.currentTime;
                        }

                        source.start(nextPlayTime);
                        nextPlayTime += audioBuffer.duration;
                    }
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error("Error en streaming:", err);
                    stopLiveStream();
                }
            }
        }

        function stopLiveStream() {
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
            if (liveAudio) {
                liveAudio.close();
                liveAudio = null;
            }
            const btn = document.getElementById('btnLive');
            btn.textContent = " Escuchar en Vivo (OFF)";
            btn.style.backgroundColor = "var(--status-gray)";
        }

        function toggleLiveAudio() {
            const btn = document.getElementById('btnLive');
            if (liveAudio == null) {
                // Pausar cualquier audio del historial
                document.querySelectorAll('audio').forEach(a => a.pause());

                playLiveStream();
                btn.textContent = " Escuchar en Vivo (ON)";
                btn.style.backgroundColor = "var(--status-green)";
            } else {
                stopLiveStream();
            }
        }

        // Polling agresivo para sensaci贸n de tiempo real fluido
        setInterval(updateDashboard, 200);

        // Cargar historial al iniciar
        loadHistory();
    </script>

</body>

</html>